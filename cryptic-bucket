#!/usr/bin/env bash
# (c) 2021 bwmabe
# FILENAME: cryptic-bucket

enc="sudo openssl aes-256-cbc -pbkdf2 "

function print_usage {
	echo "USAGE: cryptic-bucket [COMMAND] [OPTIONS]"
	echo "	create BUCKET_NAME SIZE [FS_TYPE] : Makes a bucket"
	echo "	mount BUCKET_NAME MOUNTPOINT : Mounts a bucket"
	echo "	unmount BUCKET_NAME          : unmounts a bucket"
	echo "	list                         : Lists buckets"
	echo "	help                         : prints this"
	exit $1
}	

function cb_create {
	name=$1
	size=$2
	fs_type=$3

	echo $name $size $fs_type	

	echo "Creating key"
	key=$(dd if=/dev/urandom count=4 status=none | base64)
	echo $?

	echo "Creating container"
	dd if=/dev/zero of=$name.img bs=1 seek=$size count=0 status=none
	echo $?
	echo -n $key | sudo cryptsetup luksFormat $name.img

	echo "Creating filesystem on container"
	echo -n $key | sudo cryptsetup luksOpen $name.img $name
	echo $?
	sudo mkfs.$fs_type /dev/mapper/$name

	echo "Encryping key"
	echo -n $key | $enc -out $name.key.enc

	echo -n "Mount the new bucket? (y/n): "
	read yn 
	case $yn in
		y | Y | yes |YES)
			echo -n "Mount '$name' where? (mount point): "
			read mount_point 
			cb_mount $name $mount_point
			exit 0
			;;
		*)
			sudo cryptsetup luksClose $name
			exit 0
			;;
	esac
}

function cb_mount {
	name=$1
	mount_point=$2

	echo $name $mount_point
	$enc -d -in $name.key.enc | sudo cryptsetup luksOpen $name.img $name
	sudo mount /dev/mapper/$name $mount_point
}

function cb_unmount {
	name=$1
	mount_point=$2
	sudo umount $mount_point
	sudo cryptsetup luksClose $name
}

function cb_list {
	echo ""
}

# The 1st argument passed should be the command
cmd=$1

# Shift to pop the first arg, the command. Everything after should be options
shift

case $cmd in

	help | -h | --help)
		print_usage 0
		;;
	create | -c | --create)
		cb_create "$@"
		;;
	*)
		print_usage 1
		;;
esac

# vi:syntax=sh
